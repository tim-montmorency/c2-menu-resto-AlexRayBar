name: Autograding Tests - Menu Restaurant

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    # ========================================
    # TEST 1 : Validation HTML (10 pts)
    # ========================================
    - name: Test 1 - HTML Validation
      id: test1
      continue-on-error: true
      run: |
        npm install -g html-validate
        html-validate index.html
    
    # ========================================
    # TEST 2 : Structure HTML requise (15 pts)
    # ========================================
    - name: Test 2 - Required HTML Structure
      id: test2
      continue-on-error: true
      run: |
        echo "Vérification de la structure HTML..."
        
        # Vérifie DOCTYPE
        grep -qi '<!DOCTYPE html>' index.html || { echo "❌ DOCTYPE manquant"; exit 1; }
        
        # Vérifie lang="fr"
        grep -qi 'lang="fr"' index.html || { echo "❌ lang='fr' manquant"; exit 1; }
        
        # Vérifie lien vers style.css
        grep -qi '<link.*style\.css' index.html || { echo "❌ Lien vers style.css manquant"; exit 1; }
        
        # Vérifie présence de balises sémantiques (au moins 2)
        semantic_count=$(grep -oiE '<(section|article|header|main|nav|footer)' index.html | wc -l)
        if [ "$semantic_count" -lt 2 ]; then
          echo "❌ Pas assez de balises sémantiques (trouvé: $semantic_count, requis: 2+)"
          exit 1
        fi
        
        echo "✅ Structure HTML correcte"
    
    # ========================================
    # TEST 3 : Contenu minimal (15 pts)
    # ========================================
    - name: Test 3 - Minimum Content Requirements
      id: test3
      continue-on-error: true
      run: |
        echo "Vérification du contenu minimal..."
        
        # Vérifie présence de listes (ul ou ol)
        list_count=$(grep -oiE '<(ul|ol)' index.html | wc -l)
        if [ "$list_count" -lt 1 ]; then
          echo "❌ Aucune liste trouvée (requis pour les items)"
          exit 1
        fi
        
        # Vérifie présence de li (minimum 9 pour 3 catégories × 3 items)
        li_count=$(grep -oi '<li' index.html | wc -l)
        if [ "$li_count" -lt 9 ]; then
          echo "❌ Pas assez d'items de menu (trouvé: $li_count, requis: 9+)"
          exit 1
        fi
        
        # Vérifie présence de titres (h1, h2 ou h3)
        title_count=$(grep -oiE '<h[1-3]' index.html | wc -l)
        if [ "$title_count" -lt 4 ]; then
          echo "❌ Pas assez de titres (trouvé: $title_count, requis: 4+)"
          exit 1
        fi
        
        echo "✅ Contenu minimal présent"
    
    # ========================================
    # TEST 4 : Classes CSS présentes (10 pts)
    # ========================================
    - name: Test 4 - CSS Classes Present
      id: test4
      continue-on-error: true
      run: |
        echo "Vérification des classes CSS..."
        
        # Vérifie présence d'attributs class
        class_count=$(grep -o 'class=' index.html | wc -l)
        if [ "$class_count" -lt 5 ]; then
          echo "❌ Pas assez de classes CSS (trouvé: $class_count, requis: 5+)"
          exit 1
        fi
        
        # Vérifie que style.css n'est pas vide
        if [ ! -f style.css ]; then
          echo "❌ Fichier style.css manquant"
          exit 1
        fi
        
        if [ ! -s style.css ]; then
          echo "❌ Fichier style.css vide"
          exit 1
        fi
        
        echo "✅ Classes CSS présentes"
    
    # ========================================
    # TEST 5 : Variables CSS (10 pts)
    # ========================================
    - name: Test 5 - CSS Variables
      id: test5
      continue-on-error: true
      run: |
        echo "Vérification des variables CSS..."
        
        # Vérifie présence de :root
        grep -q ':root' style.css || { echo "❌ :root manquant pour les variables"; exit 1; }
        
        # Vérifie présence d'au moins 3 variables CSS
        var_count=$(grep -o '\-\-[a-zA-Z\-]*:' style.css | wc -l)
        if [ "$var_count" -lt 3 ]; then
          echo "❌ Pas assez de variables CSS (trouvé: $var_count, requis: 3+)"
          exit 1
        fi
        
        echo "✅ Variables CSS présentes"
    
    # ========================================
    # TEST 6 : Propriétés CSS essentielles (15 pts)
    # ========================================
    - name: Test 6 - Essential CSS Properties
      id: test6
      continue-on-error: true
      run: |
        echo "Vérification des propriétés CSS essentielles..."
        
        # Vérifie padding
        grep -qi 'padding' style.css || { echo "❌ Propriété padding manquante"; exit 1; }
        
        # Vérifie margin
        grep -qi 'margin' style.css || { echo "❌ Propriété margin manquante"; exit 1; }
        
        # Vérifie border (ou border-bottom, border-top, etc.)
        grep -qiE 'border(-[a-z]+)?' style.css || { echo "❌ Propriété border manquante"; exit 1; }
        
        # Vérifie font-size
        grep -qi 'font-size' style.css || { echo "❌ Propriété font-size manquante"; exit 1; }
        
        # Vérifie color (pour la typographie)
        grep -qi 'color' style.css || { echo "❌ Propriété color manquante"; exit 1; }
        
        echo "✅ Propriétés CSS essentielles présentes"
    
    # ========================================
    # TEST 7 : État hover (5 pts)
    # ========================================
    - name: Test 7 - Hover State
      id: test7
      continue-on-error: true
      run: |
        echo "Vérification de l'état :hover..."
        
        grep -q ':hover' style.css || { echo "❌ Aucun état :hover trouvé"; exit 1; }
        
        echo "✅ État :hover présent"
    
    # ========================================
    # TEST 8 : Pas de CSS inline (5 pts)
    # ========================================
    - name: Test 8 - No Inline CSS
      id: test8
      continue-on-error: true
      run: |
        echo "Vérification qu'il n'y a pas de CSS inline..."
        
        # Vérifie qu'il n'y a pas d'attribut style (sauf exceptions)
        style_count=$(grep -o 'style=' index.html | wc -l)
        if [ "$style_count" -gt 0 ]; then
          echo "⚠️  CSS inline détecté (style= dans HTML) - Utilisez style.css"
          exit 1
        fi
        
        # Vérifie qu'il n'y a pas de balise <style>
        if grep -q '<style' index.html; then
          echo "⚠️  Balise <style> détectée - Utilisez style.css externe"
          exit 1
        fi
        
        echo "✅ Pas de CSS inline"
    
    # ========================================
    # TEST 9 : Nomenclature cohérente (bonus) (5 pts)
    # ========================================
    - name: Test 9 - Consistent Naming (BEM check)
      id: test9
      continue-on-error: true
      run: |
        echo "Vérification de la nomenclature..."
        
        # Vérifie présence de classes avec __ (BEM elements) ou -- (BEM modifiers)
        bem_count=$(grep -oE 'class="[^"]*(__|--)' index.html | wc -l)
        if [ "$bem_count" -lt 3 ]; then
          echo "⚠️  Peu de classes BEM détectées (trouvé: $bem_count)"
          echo "   BEM recommandé mais non obligatoire"
        fi
        
        echo "✅ Nomenclature vérifiée"
    
    # ========================================
    # RAPPORT FINAL
    # ========================================
    - name: Autograding Reporter
      uses: education/autograding-grading-reporter@v1
      if: always()
      env:
        TEST1_RESULTS: "${{steps.test1.outcome}}"
        TEST2_RESULTS: "${{steps.test2.outcome}}"
        TEST3_RESULTS: "${{steps.test3.outcome}}"
        TEST4_RESULTS: "${{steps.test4.outcome}}"
        TEST5_RESULTS: "${{steps.test5.outcome}}"
        TEST6_RESULTS: "${{steps.test6.outcome}}"
        TEST7_RESULTS: "${{steps.test7.outcome}}"
        TEST8_RESULTS: "${{steps.test8.outcome}}"
        TEST9_RESULTS: "${{steps.test9.outcome}}"
      with:
        runners: test1,test2,test3,test4,test5,test6,test7,test8,test9

